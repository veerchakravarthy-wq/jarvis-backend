<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JARVIS AI Voice</title>
<style>
body { background: #0f0f0f; color: #00ffe7; font-family: Arial, sans-serif; padding: 20px; }
h1 { text-align: center; }
#chat { max-width: 600px; margin: auto; }
input, button, select { width: 100%; padding: 12px; margin-top: 10px; background: #1a1a1a; color: #00ffe7; border: none; font-size: 16px; }
button { cursor: pointer; background: #00ffe7; color: #000; }
#status { font-size: 14px; color: #888; margin-top: 5px; }
.message { margin: 5px 0; padding: 6px; border-radius: 5px; }
.user { background: #003333; color: #00ffe7; }
.jarvis { background: #004d4d; color: #00ffe7; }
#messages { margin-top: 20px; }
</style>
</head>
<body>

<h1>JARVIS AI Voice</h1>

<div id="chat">
  <select id="voiceSelect"></select>
  <input id="userInput" placeholder="Type your message..." />
  <button onclick="send()">Send</button>
  <button onclick="startListening()">ðŸŽ¤ Talk to JARVIS</button>
  <div id="status"></div>
  <div id="messages"></div>
</div>

<script>
let voices = [];
let conversation = [];

// Populate voices
function populateVoices() {
  voices = speechSynthesis.getVoices();
  const select = document.getElementById("voiceSelect");
  select.innerHTML = "";
  voices.forEach((v,i)=>{
    const option = document.createElement("option");
    option.value=i;
    option.text=v.name + (v.default ? " (default)" : "");
    select.appendChild(option);
  });
}
speechSynthesis.onvoiceschanged = populateVoices;

// Send typed message
async function send() {
  const userInput = document.getElementById("userInput").value.trim();
  if(!userInput) return;
  processMessage(userInput);
  document.getElementById("userInput").value = "";
}

// Process message (typed or spoken)
async function processMessage(userMessage){
  const messagesDiv = document.getElementById("messages");
  const statusDiv = document.getElementById("status");

  // Show user message
  conversation.push({role:"user", content:userMessage});
  const userMsgDiv = document.createElement("div");
  userMsgDiv.className = "message user";
  userMsgDiv.innerText = userMessage;
  messagesDiv.appendChild(userMsgDiv);

  statusDiv.innerText = "JARVIS is thinking...";

  try {
    const response = await fetch("https://jarvis-backend-7ie0.onrender.com/chat", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ message:userMessage })
    });
    const data = await response.json();
    const replyText = data.reply || "I am unable to respond right now.";
    conversation.push({role:"jarvis", content:replyText});
    statusDiv.innerText="";

    // Show typing animation
    const jarvisMsgDiv = document.createElement("div");
    jarvisMsgDiv.className="message jarvis";
    messagesDiv.appendChild(jarvisMsgDiv);
    let i=0;
    const speed=30;
    const typeWriter=setInterval(()=>{
      jarvisMsgDiv.innerText=replyText.substring(0,i+1);
      i++;
      if(i>=replyText.length) clearInterval(typeWriter);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }, speed);

    // Voice output
    if('speechSynthesis' in window){
      const utterance = new SpeechSynthesisUtterance(replyText);
      const voiceIndex = document.getElementById("voiceSelect").value;
      if(voices[voiceIndex]) utterance.voice = voices[voiceIndex];
      utterance.lang="en-US";
      speechSynthesis.speak(utterance);
    }

  } catch(err){
    statusDiv.innerText="";
    const errorDiv = document.createElement("div");
    errorDiv.className="message jarvis";
    errorDiv.innerText="Error connecting to JARVIS.";
    messagesDiv.appendChild(errorDiv);
  }
}

// Voice input
function startListening(){
  const statusDiv = document.getElementById("status");
  if(!('webkitSpeechRecognition' in window)) {
    alert("Your browser does not support voice recognition.");
    return;
  }
  const recognition = new webkitSpeechRecognition();
  recognition.lang="en-US";
  recognition.interimResults=false;
  recognition.maxAlternatives=1;
  statusDiv.innerText="Listening...";
  recognition.start();

  recognition.onresult = function(event){
    const transcript = event.results[0][0].transcript;
    statusDiv.innerText="";
    processMessage(transcript);
  };
  recognition.onerror = function(event){
    statusDiv.innerText="";
    alert("Voice recognition error: "+event.error);
  };
}
</script>

</body>
</html>
